{% extends "base.html" %}
{% block title %}Account - PlanExe{% endblock %}
{% block head %}
<style>
    /* ── Back link ──────────────────────────────────── */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--color-text-secondary);
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 20px;
        transition: color 0.15s;
    }
    .back-link:hover { color: var(--color-text); text-decoration: none; }
    .back-link svg { width: 16px; height: 16px; }

    /* ── Page header ───────────────────────────────── */
    .acct-header {
        margin-bottom: 24px;
    }
    .acct-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 2px;
    }
    .acct-header p {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
        margin: 0;
    }

    /* ── Two-column layout ─────────────────────────── */
    .acct-grid {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 24px;
        align-items: start;
    }

    /* ── Profile sidebar ───────────────────────────── */
    .profile-card {
        background: var(--color-card-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 24px 20px;
        text-align: center;
        box-shadow: 0 1px 3px var(--color-card-shadow);
    }
    .profile-avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 12px;
        border: 2px solid var(--color-border);
    }
    .profile-avatar-placeholder {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: var(--color-primary);
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 12px;
    }
    .profile-name {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0 0 2px;
        color: var(--color-text);
    }
    .profile-email {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
        margin: 0 0 16px;
        word-break: break-all;
    }

    /* sidebar stats */
    .profile-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 16px;
    }
    .pstat {
        background: var(--color-bg-soft);
        border-radius: var(--radius);
        padding: 10px 8px;
    }
    .pstat-value {
        font-size: 1.15rem;
        font-weight: 800;
        line-height: 1.2;
        color: var(--color-text);
    }
    .pstat-value.green { color: #059669; }
    .pstat-label {
        font-size: 0.65rem;
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-top: 2px;
    }

    .profile-meta {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        border-top: 1px solid var(--color-border);
        padding-top: 12px;
        margin-top: 4px;
    }
    .profile-meta dt { font-weight: 600; color: var(--color-text); margin-top: 8px; }
    .profile-meta dt:first-child { margin-top: 0; }
    .profile-meta dd { margin: 0; }

    /* ── Content sections ──────────────────────────── */
    .acct-section {
        background: var(--color-card-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-bottom: 16px;
        box-shadow: 0 1px 3px var(--color-card-shadow);
    }
    .acct-section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 16px 20px;
        border-bottom: 1px solid var(--color-border);
    }
    .acct-section-header svg {
        width: 18px;
        height: 18px;
        color: var(--color-text-secondary);
        flex-shrink: 0;
    }
    .acct-section-header h2 {
        font-size: 0.95rem;
        font-weight: 700;
        margin: 0;
    }
    .acct-section-body {
        padding: 16px 20px;
    }

    /* ── API key section ───────────────────────────── */
    .key-display {
        background: var(--color-bg-muted);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        padding: 10px 14px;
        font-family: "SF Mono", "Fira Code", "Consolas", monospace;
        font-size: 0.82rem;
        word-break: break-all;
        margin-bottom: 12px;
        color: var(--color-text);
    }
    .key-prefix {
        font-family: "SF Mono", "Fira Code", "Consolas", monospace;
        font-size: 0.85rem;
        background: var(--color-bg-muted);
        padding: 2px 8px;
        border-radius: 4px;
    }
    .key-hint {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
        margin: 4px 0 0;
    }
    .key-new-badge {
        display: inline-block;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        background: #dcfce7;
        color: #166534;
        padding: 2px 8px;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    .key-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 12px;
    }

    /* ── Buttons (page-local overrides) ────────────── */
    .btn-acct {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: var(--radius);
        font-size: 0.82rem;
        font-weight: 600;
        text-decoration: none;
        transition: background 0.15s, border-color 0.15s;
        border: 1px solid transparent;
        cursor: pointer;
        line-height: 1.4;
    }
    .btn-acct-primary {
        background: var(--color-primary);
        color: #fff;
        border-color: var(--color-primary);
    }
    .btn-acct-primary:hover { background: var(--color-primary-hover); border-color: var(--color-primary-hover); color: #fff; }
    .btn-acct-secondary {
        background: var(--color-bg);
        color: var(--color-text);
        border-color: var(--color-border);
    }
    .btn-acct-secondary:hover { border-color: var(--color-text-secondary); }
    .btn-acct[disabled] { opacity: 0.5; cursor: not-allowed; }
    .copy-status {
        font-size: 0.8rem;
        color: #059669;
        font-weight: 500;
    }

    /* ── Credits / billing ─────────────────────────── */
    .billing-row {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    .billing-input-group {
        flex: 0 0 auto;
    }
    .billing-input-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 4px;
    }
    .billing-input {
        width: 80px;
        padding: 8px 10px;
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        font-size: 0.9rem;
        font-family: var(--font-sans);
        text-align: center;
        outline: none;
        transition: border-color 0.15s;
    }
    .billing-input:focus { border-color: var(--color-primary); }
    .billing-price-hint {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
        margin-top: 10px;
    }
    .billing-divider {
        height: 1px;
        background: var(--color-border);
        margin: 14px 0;
    }

    /* ── Payments table ────────────────────────────── */
    .payments-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.82rem;
    }
    .payments-table th {
        text-align: left;
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        padding: 8px 10px;
        border-bottom: 2px solid var(--color-border);
    }
    .payments-table td {
        padding: 8px 10px;
        border-bottom: 1px solid var(--color-border);
        color: var(--color-text);
        vertical-align: middle;
    }
    .payments-table tr:last-child td { border-bottom: none; }
    .payments-table code {
        font-size: 0.75rem;
        background: var(--color-bg-muted);
        padding: 1px 6px;
        border-radius: 3px;
    }
    .status-badge {
        display: inline-block;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: capitalize;
        padding: 2px 8px;
        border-radius: 10px;
    }
    .status-badge.completed, .status-badge.paid { background: #dcfce7; color: #166534; }
    .status-badge.pending { background: #fef3c7; color: #92400e; }
    .status-badge.failed, .status-badge.cancelled { background: #fee2e2; color: #991b1b; }
    .empty-hint {
        text-align: center;
        padding: 24px 16px;
        color: var(--color-text-secondary);
        font-size: 0.85rem;
    }

    /* ── Responsive ────────────────────────────────── */
    @media (max-width: 720px) {
        .acct-grid {
            grid-template-columns: 1fr;
        }
        .profile-card {
            text-align: left;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
            padding: 16px;
        }
        .profile-avatar, .profile-avatar-placeholder { margin-bottom: 0; }
        .profile-info-mobile { flex: 1; min-width: 140px; }
        .profile-stats { width: 100%; }
    }
</style>
{% endblock %}

{% block content %}
{# ── Back to dashboard ──────────────────────────────────────── #}
<a href="{{ url_for('index') }}" class="back-link">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    Back to Dashboard
</a>

<div class="acct-header">
    <h1>Account</h1>
    <p>Manage your profile, API access, and billing.</p>
</div>

<div class="acct-grid">
    {# ── Left: profile sidebar ─────────────────────────────────── #}
    <aside>
        <div class="profile-card">
            {% if user.avatar_url %}
                <img src="{{ user.avatar_url }}" alt="" class="profile-avatar">
            {% else %}
                <span class="profile-avatar-placeholder">{{ (user.name or user.email or "?")[0] | upper }}</span>
            {% endif %}
            <div class="profile-info-mobile">
                <p class="profile-name">{{ user.name or user.given_name or "—" }}</p>
                <p class="profile-email">{{ user.email or "No email on file" }}</p>
            </div>

            <div class="profile-stats">
                <div class="pstat">
                    <div class="pstat-value green">{{ credits_balance_display }}</div>
                    <div class="pstat-label">Credits</div>
                </div>
                <div class="pstat">
                    <div class="pstat-value">{{ "Used" if user.free_plan_used else "Free" }}</div>
                    <div class="pstat-label">Free Plan</div>
                </div>
            </div>

            <dl class="profile-meta">
                <dt>Pricing</dt>
                <dd>1 credit = ${{ "%.2f"|format((credit_price_cents or 100) / 100.0) }}</dd>
                {% if user.created_at %}
                <dt>Member since</dt>
                <dd>{{ user.created_at.strftime("%b %d, %Y") }}</dd>
                {% endif %}
            </dl>
        </div>
    </aside>

    {# ── Right: content sections ───────────────────────────────── #}
    <div>
        {# ── API Key ────────────────────────────────────────────── #}
        <div class="acct-section">
            <div class="acct-section-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                <h2>API Key</h2>
            </div>
            <div class="acct-section-body">
                {% if new_api_key %}
                    <span class="key-new-badge">New — shown once</span>
                    <div class="key-display" id="new-api-key">{{ new_api_key }}</div>
                    <p class="key-hint">Copy this key now. You will not be able to see it again.</p>
                    <div class="key-actions">
                        <button type="button" class="btn-acct btn-acct-primary" id="copy-api-key">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            Copy to clipboard
                        </button>
                        <span id="copy-api-key-status" class="copy-status"></span>
                    </div>
                {% elif active_key %}
                    <p style="margin: 0 0 4px; font-size: 0.85rem;">Active key: <span class="key-prefix">{{ active_key.key_prefix }}…</span></p>
                    <p class="key-hint">Use the full key you saved when it was created.</p>
                {% else %}
                    <p style="margin: 0 0 4px; font-size: 0.85rem; color: var(--color-text-secondary);">No API key yet. Generate one to use PlanExe via the MCP or HTTP API.</p>
                {% endif %}

                <div class="key-actions">
                    <form method="POST" style="margin: 0;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="regenerate_api_key">
                        <button class="btn-acct btn-acct-secondary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            {{ "Regenerate key" if active_key else "Generate key" }}
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {# ── Buy Credits ───────────────────────────────────────── #}
        <div class="acct-section">
            <div class="acct-section-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                <h2>Buy Credits</h2>
            </div>
            <div class="acct-section-body">
                <form method="POST" action="/billing/stripe/checkout">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="billing-row">
                        <div class="billing-input-group">
                            <label for="credits">Credits</label>
                            <input type="number" class="billing-input" name="credits" id="credits" value="1" min="1">
                        </div>
                        {% if stripe_enabled %}
                            <button class="btn-acct btn-acct-primary">Pay with Stripe</button>
                        {% else %}
                            <button class="btn-acct btn-acct-primary" disabled>Stripe not configured</button>
                        {% endif %}
                    </div>
                </form>
                <p class="billing-price-hint">1 credit = ${{ "%.2f"|format((credit_price_cents or 100) / 100.0) }} USD</p>

                {% if telegram_enabled %}
                    <div class="billing-divider"></div>
                    <form method="POST" action="/billing/telegram/invoice">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="billing-row">
                            <div class="billing-input-group">
                                <label for="credits_telegram">Credits</label>
                                <input type="number" class="billing-input" name="credits" id="credits_telegram" value="1" min="1">
                            </div>
                            <button class="btn-acct btn-acct-secondary">Pay with Telegram Stars</button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>

        {# ── Payment History ───────────────────────────────────── #}
        <div class="acct-section">
            <div class="acct-section-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                <h2>Payment History</h2>
            </div>
            {% if recent_payments %}
            <div style="overflow-x: auto;">
                <table class="payments-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Provider</th>
                            <th>Status</th>
                            <th>Credits</th>
                            <th>Amount</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in recent_payments %}
                        <tr>
                            <td>{{ p.created_at }}</td>
                            <td>{{ p.provider }}</td>
                            <td><span class="status-badge {{ p.status }}">{{ p.status }}</span></td>
                            <td>{{ p.credits }}</td>
                            <td>${{ "%.2f"|format(p.amount_major) }} {{ p.currency }}</td>
                            <td><code>{{ p.payment_id }}</code></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="empty-hint">No payments yet.</div>
            {% endif %}
        </div>
    </div>
</div>

{% if new_api_key %}
<script>
    // clipboard copy handler for the new API key
    (function () {
        var button = document.getElementById("copy-api-key");
        var keyEl = document.getElementById("new-api-key");
        var statusEl = document.getElementById("copy-api-key-status");
        if (!button || !keyEl || !statusEl) return;

        function setStatus(msg) {
            statusEl.textContent = msg;
            if (msg) setTimeout(function () { statusEl.textContent = ""; }, 3000);
        }

        button.addEventListener("click", function () {
            var text = keyEl.textContent.trim();
            if (!text) { setStatus("Nothing to copy"); return; }
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(function () { setStatus("Copied!"); }).catch(function () { setStatus("Copy failed"); });
                return;
            }
            var ta = document.createElement("textarea");
            ta.value = text; ta.setAttribute("readonly", "");
            ta.style.position = "absolute"; ta.style.left = "-9999px";
            document.body.appendChild(ta); ta.select();
            try { document.execCommand("copy"); setStatus("Copied!"); }
            catch (e) { setStatus("Copy failed"); }
            document.body.removeChild(ta);
        });
    })();
</script>
{% endif %}
{% endblock %}
